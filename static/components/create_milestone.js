export default {
  template: `
   <div class="create-milestone-page">
    <section class="page-header">
      <div class="header-content">
        <h1 class="hero-title">Create Project</h1>
        <p class="hero-subtitle">Define your project and set milestones with ease.</p>
      </div>
    </section>

    <section class="milestone-form">
      <form @submit.prevent="createProject">
        <div class="form-group">
          <label for="project-heading" class="form-label">Project Title</label>
          <input type="text" id="project-heading" v-model="projectHeading" class="form-control" placeholder="Enter project heading" required />
        </div>

        <div class="form-group ai-group">
          <label for="project-description" class="form-label">Project Description</label>
          <input type="text" id="project-description" v-model="projectDescription" class="form-control" placeholder="Enter project description" required />
          <button type="button" class="ai-button" @click="fetchMilestonesFromAI">AI</button>
        </div>

        <!-- Dynamic Milestones -->
        <div v-for="(milestone, index) in milestones" :key="index" class="milestone-inputs">
          <div class="milestone-header">
            <h3>Milestone {{ index + 1 }}</h3>
            <button type="button" class="remove-button" @click="removeMilestone(index)">âœ–</button>
          </div>
          <div class="form-group">
            <label :for="'milestone-task-' + index" class="form-label">Task</label>
            <input type="text" :id="'milestone-task-' + index" v-model="milestone.task" class="form-control" placeholder="Enter task name" required />
          </div>
          <div class="form-group">
            <label :for="'milestone-desc-' + index" class="form-label">Description</label>
            <textarea :id="'milestone-desc-' + index" v-model="milestone.description" class="form-control" placeholder="Enter task description" required></textarea>
          </div>
          <div class="form-group">
            <label :for="'milestone-deadline-' + index" class="form-label">Deadline</label>
            <input type="date" :id="'milestone-deadline-' + index" v-model="milestone.deadline" class="form-control" required />
          </div>
        </div>

        <!-- Add Milestone Button -->
        <div class="add-milestone-button">
          <button type="button" class="plus-button text-center" @click="addMilestone">+</button>
        </div>

        <button type="submit" class="create-button">Create Project</button>
      </form>
    </section>
  </div>`,

  data() {
      return {
          projectHeading: '',
          projectDescription: '',
          milestones: [] // Start with an empty array
      };
  },

  methods: {
      addMilestone() {
          // Add a new empty milestone object to the milestones array
          this.milestones.push({ task: '', description: '', deadline: '' });
      },

      removeMilestone(index) {
          // Remove the milestone at the given index
          this.milestones.splice(index, 1);
      },

      async fetchMilestonesFromAI() {
          try {
              const response = await fetch('https://api.example.com/generate-milestones', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authentication-Token': localStorage.getItem('auth-token')
                  },
                  body: JSON.stringify({
                      projectHeading: this.projectHeading,
                      projectDescription: this.projectDescription
                  })
              });
              const data = await response.json();

              // Populate the milestones array with the response
              if (data.milestones && data.milestones.length) {
                  this.milestones = data.milestones.map(milestone => ({
                      task: milestone.task,
                      description: milestone.description,
                      deadline: milestone.deadline || ''
                  }));
              } else {
                  alert('No milestones generated by AI. Please try again.');
              }
          } catch (error) {
              console.error('Error fetching milestones from AI:', error);
              alert('Failed to fetch milestones from AI. Please check your connection and try again.');
          }
      },

      async createProject() {
        try {
            // Step 1: Send Project Data to Backend
            const projectResponse = await fetch('/project', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authentication-Token': localStorage.getItem('auth-token')
                },
                body: JSON.stringify({
                    title: this.projectHeading,
                    description: this.projectDescription
                })
            });

            const projectData = await projectResponse.json();

            if (!projectResponse.ok) {
                throw new Error(projectData.message || 'Failed to create project.');
            }

            const { projectId, title, description } = projectData;
            console.log('Project Created:', { projectId, title, description });

            // Step 2: Send Milestones Data to Backend
            const milestonesResponse = await fetch('/milestone', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authentication-Token': localStorage.getItem('auth-token')
                },
                body: JSON.stringify({
                    projectId: projectId,
                    milestones: this.milestones
                })
            });

            const milestonesData = await milestonesResponse.json();

            if (!milestonesResponse.ok) {
                throw new Error(milestonesData.message || 'Failed to create milestones.');
            }

            console.log('Milestones Created:', milestonesData);

            alert('Project and milestones created successfully!');
            this.$router.push(`/projects/${projectId}`)
        } catch (error) {
            console.error('Error creating milestones:', error);
            alert('Failed to create milestones. Please try again.');
        }
    }
  }
};
